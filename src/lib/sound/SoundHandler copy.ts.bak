// i dont know what to name these help

import * as Tone from "tone";
import Instrument, { DEFAULT_INSTRUMENT, InstrumentID } from "./Instruments"
import { ServerNotePayload, LOCAL_CLIENT_ID, SwitchInstrumentPayload, KeyboardPayload} from "../net/PotatoServer";
import { Optional } from "../TypeUtil";
import PotatoNet, { PotatoPeerId } from "../net/PotatoNet";
import { DEFAULT_KEYBOARD_DATA, Keyboard, KeyboardData, KeyboardID } from "./Keyboard";

/** This payload might come from the user itself or from a remote client */
export type NoteEventPayload = Optional<ServerNotePayload, "id">
export type ClientSwitchInstrumentPayload = Optional<SwitchInstrumentPayload, "id">
export type ClientKeyboardPayload = Optional<KeyboardPayload, "id">

export default class SoundHandler {

    loaded: boolean

    peer_keyboards: Map<PotatoPeerId, Keyboard[]>
    peer_keyboards_data: Map<PotatoPeerId, KeyboardData[]>

    constructor() {
        this.peer_keyboards = new Map<PotatoPeerId, Keyboard[]>();
        this.peer_keyboards_data = new Map<PotatoPeerId, KeyboardData[]>();
        this.loaded = false
    }

    static async init() {
        await Tone.start()
    }

    load_peer_keyboard(peer: PotatoPeerId, keyboard_id: KeyboardID) {
        if (peer === undefined) {
            peer = LOCAL_CLIENT_ID
        }
        
        this.init_peer_keyboards(peer)
        let keyboard_data: KeyboardData = this.peer_keyboards_data.get(peer)[keyboard_id]

        if (keyboard_data === undefined) {
            console.log("keyboard_data undefined??? set it please")
            this.set_defaults(peer, keyboard_id)
        }

        if (!this.peer_is_correct_keyboard_loaded(peer, keyboard_data)) {
            this.peer_keyboards.get(peer)?.push(new Keyboard(keyboard_data))
        }
    }
    change_peer_keyboard_instrument(peer: PotatoPeerId, keyboard_id: KeyboardID, instrument: InstrumentID) {
        if (peer === undefined) {
            peer = LOCAL_CLIENT_ID
        }
        
        this.init_peer_keyboards(peer)
        let keyboards = this.peer_keyboards.get(peer)
        keyboards?.forEach((element) => {
            
        })
        if (keyboards[keyboard_id] === undefined) {
            this.load_peer_keyboard(peer, keyboard_id)
        }
        keyboards[keyboard_id].set_instrument(instrument)
    }

    init_peer_keyboards(peer: PotatoPeerId) {
        if (this.peer_keyboards.get(peer) === undefined) this.peer_keyboards.set(peer, [])
        if (this.peer_keyboards_data.get(peer) === undefined) this.peer_keyboards_data.set(peer, [])
    }

    set_defaults(peer: PotatoPeerId, keyboard_id: KeyboardID) {
        if (peer === undefined) {
            peer = LOCAL_CLIENT_ID
        }
        this.init_peer_keyboards(peer)

        let keyboards_data = this.peer_keyboards_data.get(peer)
        if (keyboards_data === undefined) {
            throw new Error("i must be asleep or something cuz this is not possible")
        }

        if (keyboards_data[keyboard_id] === undefined) {
            keyboards_data[keyboard_id] = DEFAULT_KEYBOARD_DATA
        }

        if (this.peer_keyboards.size === 0) {
            this.load_peer_keyboard(peer, 0)
        }
    }

    set_peer_keyboard(peer: PotatoPeerId, keyboard_data: KeyboardData): KeyboardID {
        if (peer === undefined) {
            peer = LOCAL_CLIENT_ID
        }
        
        this.init_peer_keyboards(peer)

        keyboard_data.keyboard_id = this.peer_keyboards_data.get(peer)?.length || 0
        let keyboards = this.peer_keyboards.get(peer)
        if (keyboards && keyboards[keyboard_data.keyboard_id] !== undefined) keyboards[keyboard_data.keyboard_id].release_all();

        this.peer_keyboards_data.get(peer)?.push(keyboard_data)
        this.load_peer_keyboard(peer, keyboard_data.keyboard_id)

        return keyboard_data.keyboard_id
    }

    peer_is_any_keyboard_loaded(peer: PotatoPeerId) {
        return this.peer_keyboards.get(peer) !== undefined
    }
    peer_is_correct_keyboard_loaded(peer: PotatoPeerId, correct_keyboard_data: KeyboardData): boolean {
        let keyboards = this.peer_keyboards.get(peer)
        if (keyboards === undefined)
            return false

        let keyboard_id = correct_keyboard_data.keyboard_id || 0
        let keyboard = keyboards[keyboard_id]
        
        if (keyboard === undefined)
            return false


        return keyboard.get_serializable_configuration() === correct_keyboard_data
    }

    set_loaded() {
        this.loaded = true
    }

    async play(note_event: NoteEventPayload) {
        if(PotatoNet.processing === undefined) return;
        this.init_peer_keyboards(note_event.id)

        let peer_id = note_event.id || PotatoNet.processing.localId
        
        let peer_keyboards = this.peer_keyboards_data.get(peer_id)
        if (peer_keyboards === undefined) {
            throw new Error("GOONERS CRISPED UP IN THE SUN: PEER HAS NO KEYBOARDS!!")
        }

        let keyboard_id = note_event.keyboard_id
        if (keyboard_id === undefined) {
            throw new Error("GOONERS CRISPED UP IN THE SUN: KEYBOARD ID IS UNDEFINED!!")
        }

        let keyboard_data: KeyboardData = peer_keyboards[keyboard_id]
        this.load_peer_keyboard(peer_id, keyboard_data)

        console.log("peer id " + peer_id)

        if (note_event.event === "pressed")
            this.press(note_event.note, peer_id, keyboard_id)
        else
            this.release(note_event.note, peer_id, keyboard_id)
    }

    async press(pitch: number, peer: PotatoPeerId, keyboard: KeyboardID) {
        let keyboards = this.peer_keyboards.get(peer)

        keyboards[keyboard].press(pitch)
    }

    async release(pitch: number, peer: PotatoPeerId, keyboard: KeyboardID) {
        let keyboards = this.peer_keyboards.get(peer)

        keyboards[keyboard].release(pitch)
    }


}